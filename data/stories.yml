version: "3.1"

stories:
  # ================================ Đề xuất bác sĩ =============================================================
  - story: happy path doctor recommendation
    steps:
      - intent: greet
      - action: utter_greet
      - intent: request_doctor
      - action: action_set_current_task
      - slot_was_set:
          - current_task: request_doctor
      - action: recommend_doctor_form
      - active_loop: recommend_doctor_form
      - intent: provide_medical_info
      - slot_was_set:
          - symptoms: [đau đầu, sốt]
      - active_loop: null
      - action: action_recommend_doctor

  - story: greet without doctor
    steps:
      - intent: greet
      - action: utter_greet
      - intent: goodbye
      - action: utter_goodbye

  # ================================ Đề xuất bác sĩ + đặt lịch =============================================================
  - story: Recommend doctor with book appointment
    steps:
      - intent: greet
      - action: utter_greet
      - intent: request_doctor
      - action: action_set_current_task
      - slot_was_set:
          - current_task: request_doctor
      - action: recommend_doctor_form
      - active_loop: recommend_doctor_form
      - intent: provide_medical_info
      - slot_was_set:
          - symptoms: [đau đầu, sốt]
      - active_loop: null
      - action: action_recommend_doctor
      - intent: book_with_doctor
      - slot_was_set:
          - doctor_id: "BS001"
      - action: action_book_with_doctor
      - action: action_set_current_task
      - slot_was_set:
          - current_task: book_appointment
      - action: book_appointment_form
      - active_loop: book_appointment_form

  # ================================ Đặt lịch khám =============================================================
  - story: happy path book appointment
    steps:
      - intent: greet
      - action: utter_greet
      - intent: book_appointment
      - action: action_set_current_task
      - slot_was_set:
          - current_task: book_appointment
      - action: book_appointment_form
      - active_loop: book_appointment_form
      - intent: provide_specialty
      - slot_was_set:
          - specialty: nhi khoa
      - intent: choose_doctor_name
      - slot_was_set:
          - doctor_name: bác sĩ Anh
      - intent: provide_date
      - slot_was_set:
          - date: "20/10/2025"
      - intent: provide_time
      - slot_was_set:
          - appointment_time: "15:00"
      - intent: provide_decription
      - slot_was_set:
          - decription: khám bệnh cho con tôi
      - active_loop: null
      - action: action_book_appointment
      - intent: affirm
      - action: action_submit_booking

  # ================================ Hủy lịch hẹn - SỬA FLOW =============================================================
  - story: happy path cancel appointment
    steps:
      - intent: greet
      - action: utter_greet
      - intent: cancel_appointment
      - action: action_cancel_appointment
      - action: cancel_appointment_form
      - active_loop: cancel_appointment_form
      - intent: provide_date
      - slot_was_set:
          - appointment_date: "21/10/2025"
      - intent: select_appointment # User chọn lịch (fill slot thứ 2)
      - slot_was_set:
          - selected_appointment_id: "LH001"
      - active_loop: null # Form deactivate
      - action: action_confirm_cancel # ← Rule tự động gọi
      - intent: affirm
      - action: action_perform_cancel

  - story: cancel appointment with interruption - explain specialty
    steps:
      - intent: greet
      - action: utter_greet
      - intent: cancel_appointment
      - action: action_cancel_appointment
      - action: cancel_appointment_form
      - active_loop: cancel_appointment_form
      - intent: explain_specialty
      - slot_was_set:
          - just_explained: true
      - action: action_explain_specialty_in_form
      - slot_was_set:
          - just_explained: false
      - action: cancel_appointment_form
      - active_loop: cancel_appointment_form
      - intent: provide_date
      - slot_was_set:
          - appointment_date: "21/10/2025"
      - intent: select_appointment
      - slot_was_set:
          - selected_appointment_id: "LH001"
      - active_loop: null
      - action: action_confirm_cancel
      - intent: affirm
      - action: action_perform_cancel

  - story: cancel appointment with interruption - ask doctor info
    steps:
      - intent: greet
      - action: utter_greet
      - intent: cancel_appointment
      - action: action_cancel_appointment
      - action: cancel_appointment_form
      - active_loop: cancel_appointment_form
      - intent: ask_doctor_info
      - slot_was_set:
          - just_asked_doctor_info: true
      - action: action_show_doctor_info_in_form
      - slot_was_set:
          - just_asked_doctor_info: false
      - action: cancel_appointment_form
      - active_loop: cancel_appointment_form
      - intent: provide_date
      - slot_was_set:
          - appointment_date: "21/10/2025"
      - intent: select_appointment
      - slot_was_set:
          - selected_appointment_id: "LH001"
      - active_loop: null
      - action: action_confirm_cancel
      - intent: affirm
      - action: action_perform_cancel

  - story: cancel appointment with interruption - list doctors
    steps:
      - intent: greet
      - action: utter_greet
      - intent: cancel_appointment
      - action: action_cancel_appointment
      - action: cancel_appointment_form
      - active_loop: cancel_appointment_form
      - intent: list_doctors_by_specialty
      - slot_was_set:
          - just_listed_doctors: true
      - action: action_list_doctors_in_form
      - slot_was_set:
          - just_listed_doctors: false
      - action: cancel_appointment_form
      - active_loop: cancel_appointment_form
      - intent: provide_date
      - slot_was_set:
          - appointment_date: "21/10/2025"
      - intent: select_appointment
      - slot_was_set:
          - selected_appointment_id: "LH001"
      - active_loop: null
      - action: action_confirm_cancel
      - intent: affirm
      - action: action_perform_cancel

  - story: cancel appointment - no appointments found
    steps:
      - intent: greet
      - action: utter_greet
      - intent: cancel_appointment
      - action: action_cancel_appointment
      - action: cancel_appointment_form
      - active_loop: cancel_appointment_form
      - intent: provide_date
      - slot_was_set:
          - appointment_date: "25/10/2025"
      - active_loop: null
      - action: utter_greet

  # ================================ Xử lý deny (hủy) =============================================================
  - story: deny book appointment confirmation
    steps:
      - intent: greet
      - action: utter_greet
      - intent: book_appointment
      - action: action_set_current_task
      - slot_was_set:
          - current_task: book_appointment
      - action: book_appointment_form
      - active_loop: book_appointment_form
      - intent: provide_specialty
      - slot_was_set:
          - specialty: nhi khoa
      - intent: choose_doctor_name
      - slot_was_set:
          - doctor_name: bác sĩ Anh
      - intent: provide_date
      - slot_was_set:
          - date: "20/10/2025"
      - intent: provide_time
      - slot_was_set:
          - appointment_time: "15:00"
      - intent: provide_decription
      - slot_was_set:
          - decription: khám bệnh cho con tôi
      - active_loop: null
      - action: action_book_appointment
      - intent: deny
      - action: action_handle_deny
      - active_loop: null
      - slot_was_set:
          - current_task: null
      - action: utter_ask_intent

  - story: deny cancel appointment confirmation
    steps:
      - intent: greet
      - action: utter_greet
      - intent: cancel_appointment
      - action: action_cancel_appointment
      - action: cancel_appointment_form
      - active_loop: cancel_appointment_form
      - intent: provide_date
      - slot_was_set:
          - appointment_date: "19/10/2025"
      - intent: select_appointment
      - slot_was_set:
          - selected_appointment_id: "LH001"
      - active_loop: null
      - action: action_confirm_cancel
      - intent: deny
      - action: action_handle_deny
      - active_loop: null
      - slot_was_set:
          - current_task: null
      - action: utter_ask_intent

  - story: deny during book appointment form
    steps:
      - intent: greet
      - action: utter_greet
      - intent: book_appointment
      - action: action_set_current_task
      - slot_was_set:
          - current_task: book_appointment
      - action: book_appointment_form
      - active_loop: book_appointment_form
      - intent: provide_specialty
      - slot_was_set:
          - specialty: nhi khoa
      - intent: deny
      - action: action_handle_deny
      - active_loop: null
      - slot_was_set:
          - current_task: null
      - action: utter_ask_intent

  - story: deny during cancel appointment form
    steps:
      - intent: greet
      - action: utter_greet
      - intent: cancel_appointment
      - action: action_cancel_appointment
      - action: cancel_appointment_form
      - active_loop: cancel_appointment_form
      - intent: deny
      - action: action_handle_deny
      - active_loop: null
      - slot_was_set:
          - current_task: null
      - action: utter_ask_intent

  - story: deny during recommend doctor form
    steps:
      - intent: greet
      - action: utter_greet
      - intent: request_doctor
      - action: action_set_current_task
      - slot_was_set:
          - current_task: request_doctor
      - action: recommend_doctor_form
      - active_loop: recommend_doctor_form
      - intent: deny
      - action: action_handle_deny
      - active_loop: null
      - slot_was_set:
          - current_task: null
      - action: utter_ask_intent

  - story: general deny after greet
    steps:
      - intent: greet
      - action: utter_greet
      - intent: book_appointment
      - action: action_set_current_task
      - slot_was_set:
          - current_task: book_appointment
      - action: book_appointment_form
      - active_loop: book_appointment_form
      - intent: deny
      - action: action_handle_deny
      - slot_was_set:
          - current_task: null
      - action: utter_ask_intent

  # ================================ Out of Scope Stories =============================================================
  - story: out of scope at start
    steps:
      - intent: greet
      - action: utter_greet
      - intent: out_of_scope
      - action: action_handle_out_of_scope
      - intent: book_appointment
      - action: action_set_current_task
      - slot_was_set:
          - current_task: book_appointment
      - action: book_appointment_form
      - active_loop: book_appointment_form

  - story: out of scope during booking form
    steps:
      - intent: book_appointment
      - action: action_set_current_task
      - action: book_appointment_form
      - active_loop: book_appointment_form
      - intent: provide_specialty
      - slot_was_set:
          - specialty: nhi khoa
      - intent: out_of_scope # User hỏi câu không liên quan
      - action: action_handle_out_of_scope
      # Form vẫn tiếp tục
      - intent: choose_doctor_name
      - slot_was_set:
          - doctor_name: bác sĩ Anh
      - active_loop: null
      - action: action_book_appointment

  - story: out of scope during cancel form
    steps:
      - intent: cancel_appointment
      - action: action_cancel_appointment
      - action: cancel_appointment_form
      - active_loop: cancel_appointment_form
      - intent: out_of_scope # User hỏi về thời tiết chẳng hạn
      - action: action_handle_out_of_scope
      # Form tiếp tục
      - intent: provide_date
      - slot_was_set:
          - appointment_date: "21/10/2025"
      - active_loop: null

  - story: multiple out of scope questions
    steps:
      - intent: greet
      - action: utter_greet
      - intent: out_of_scope
      - action: action_handle_out_of_scope
      - intent: out_of_scope # Hỏi tiếp
      - action: action_handle_out_of_scope
      - intent: out_of_scope # Hỏi lần 3
      - action: action_handle_out_of_scope
      - intent: book_appointment # Cuối cùng mới hỏi đúng
      - action: action_set_current_task
      - slot_was_set:
          - current_task: book_appointment
      - action: book_appointment_form
      - active_loop: book_appointment_form

  - story: nlu fallback then clarify
    steps:
      - intent: greet
      - action: utter_greet
      - intent: nlu_fallback
      - action: action_default_fallback
      - intent: book_appointment # User nói rõ hơn
      - action: action_set_current_task
      - slot_was_set:
          - current_task: book_appointment
      - action: book_appointment_form
      - active_loop: book_appointment_form

  # ← THÊM: Fallback trong book_appointment_form với recovery
  - story: nlu fallback during booking form - specialty slot
    steps:
      - intent: book_appointment
      - action: action_set_current_task
      - action: book_appointment_form
      - active_loop: book_appointment_form
      - intent: nlu_fallback # User gõ "ờ", "ừ", "asdfgh"
      - action: action_default_fallback
      # Form tự động hỏi lại specialty
      - intent: provide_specialty
      - slot_was_set:
          - specialty: nhi khoa
      - intent: choose_doctor_name
      - slot_was_set:
          - doctor_name: bác sĩ Anh
      - intent: provide_date
      - slot_was_set:
          - date: "20/10/2025"
      - intent: provide_time
      - slot_was_set:
          - appointment_time: "15:00"
      - intent: provide_decription
      - slot_was_set:
          - decription: khám bệnh
      - active_loop: null
      - action: action_book_appointment

  # ← THÊM: Multiple fallbacks trong form
  - story: multiple nlu fallbacks in booking form
    steps:
      - intent: book_appointment
      - action: action_set_current_task
      - action: book_appointment_form
      - active_loop: book_appointment_form
      - intent: nlu_fallback # Lần 1
      - action: action_default_fallback
      - intent: nlu_fallback # Lần 2 - vẫn không hiểu
      - action: action_default_fallback
      - intent: provide_specialty # Cuối cùng trả lời đúng
      - slot_was_set:
          - specialty: nội khoa
      - intent: choose_doctor_name
      - slot_was_set:
          - doctor_name: bác sĩ B
      - active_loop: null

  # ← THÊM: Fallback ở nhiều slot khác nhau
  - story: nlu fallback at different slots in booking form
    steps:
      - intent: book_appointment
      - action: action_set_current_task
      - action: book_appointment_form
      - active_loop: book_appointment_form
      - intent: provide_specialty
      - slot_was_set:
          - specialty: nhi khoa
      - intent: nlu_fallback # Fallback ở doctor_name
      - action: action_default_fallback
      - intent: choose_doctor_name
      - slot_was_set:
          - doctor_name: bác sĩ Anh
      - intent: nlu_fallback # Fallback ở date
      - action: action_default_fallback
      - intent: provide_date
      - slot_was_set:
          - date: "21/10/2025"
      - intent: provide_time
      - slot_was_set:
          - appointment_time: "14:00"
      - intent: provide_decription
      - slot_was_set:
          - decription: khám
      - active_loop: null
      - action: action_book_appointment

  # ← THÊM: Fallback trong cancel_appointment_form
  - story: nlu fallback in cancel appointment form
    steps:
      - intent: cancel_appointment
      - action: action_cancel_appointment
      - action: cancel_appointment_form
      - active_loop: cancel_appointment_form
      - intent: nlu_fallback # User không hiểu cách nhập ngày
      - action: action_default_fallback
      - intent: provide_date # Nhập đúng lần 2
      - slot_was_set:
          - appointment_date: "22/10/2025"
      - intent: select_appointment
      - slot_was_set:
          - selected_appointment_id: "LH001"
      - active_loop: null
      - action: action_confirm_cancel

  # ← THÊM: Fallback trong recommend_doctor_form
  - story: nlu fallback in recommend doctor form
    steps:
      - intent: request_doctor
      - action: action_set_current_task
      - action: recommend_doctor_form
      - active_loop: recommend_doctor_form
      - intent: nlu_fallback # User không biết cách mô tả triệu chứng
      - action: action_default_fallback
      - intent: provide_medical_info # Mô tả lại
      - slot_was_set:
          - symptoms: [đau đầu, sốt]
      - active_loop: null
      - action: action_recommend_doctor

  - story: out of scope after recommendation
    steps:
      - intent: request_doctor
      - action: action_set_current_task
      - action: recommend_doctor_form
      - active_loop: recommend_doctor_form
      - intent: provide_medical_info
      - slot_was_set:
          - symptoms: [đau đầu]
      - active_loop: null
      - action: action_recommend_doctor
      - intent: out_of_scope # Hỏi câu khác thay vì đặt lịch
      - action: action_handle_out_of_scope
      - intent: goodbye
      - action: utter_goodbye

  - story: out of scope before confirmation
    steps:
      - intent: book_appointment
      - action: action_set_current_task
      - action: book_appointment_form
      - active_loop: book_appointment_form
      - intent: provide_specialty
      - slot_was_set:
          - specialty: nhi khoa
      - intent: choose_doctor_name
      - slot_was_set:
          - doctor_name: bác sĩ Anh
      - intent: provide_date
      - slot_was_set:
          - date: "20/10/2025"
      - intent: provide_time
      - slot_was_set:
          - appointment_time: "15:00"
      - intent: provide_decription
      - slot_was_set:
          - decription: khám cho con
      - active_loop: null
      - action: action_book_appointment
      - intent: out_of_scope # Thay vì affirm/deny
      - action: action_handle_out_of_scope
      - intent: affirm # Sau đó mới xác nhận
      - action: action_submit_booking

  - story: fallback in form then continue
    steps:
      - intent: book_appointment
      - action: action_set_current_task
      - action: book_appointment_form
      - active_loop: book_appointment_form
      - intent: nlu_fallback # User gõ lung tung
      - action: action_default_fallback
      - intent: provide_specialty # Sau đó trả lời đúng
      - slot_was_set:
          - specialty: nhi khoa
      - active_loop: null

  - story: out of scope with recovery
    steps:
      - intent: greet
      - action: utter_greet
      - intent: out_of_scope
      - action: action_handle_out_of_scope
      - intent: request_doctor # User hiểu và chọn đúng chức năng
      - action: action_set_current_task
      - action: recommend_doctor_form
      - active_loop: recommend_doctor_form

  - story: persistent out of scope user
    steps:
      - intent: greet
      - action: utter_greet
      - intent: out_of_scope
      - action: action_handle_out_of_scope
      - intent: out_of_scope
      - action: action_handle_out_of_scope
      - intent: out_of_scope
      - action: action_handle_out_of_scope
      - intent: goodbye # User bỏ cuộc
      - action: utter_goodbye

  # ================================ TÌM TOA THUỐC =============================================================

  # ← THÊM: Happy path tìm toa thuốc theo ngày
  - story: happy path search prescription by date
    steps:
      - intent: greet
      - action: utter_greet
      - intent: search_prescription
      - action: action_search_prescription
      - slot_was_set:
          - current_task: search_prescription
      - action: search_prescription_form
      - active_loop: search_prescription_form
      - intent: provide_date
      - slot_was_set:
          - prescription_date: "15/10/2025"
      - active_loop: null
      - action: action_show_prescription_results

  # ← THÊM: Tìm toa thuốc mới nhất
  - story: search latest prescription
    steps:
      - intent: greet
      - action: utter_greet
      - intent: request_latest_prescription
      - action: action_get_latest_prescription
      - slot_was_set:
          - search_latest_prescription: true
      - action: search_prescription_form
      - active_loop: search_prescription_form
      - active_loop: null
      - action: action_show_prescription_results

  # ← THÊM: Tìm toa thuốc với interruption - explain specialty
  - story: search prescription with explain specialty interruption
    steps:
      - intent: greet
      - action: utter_greet
      - intent: search_prescription
      - action: action_search_prescription
      - action: search_prescription_form
      - active_loop: search_prescription_form
      - intent: explain_specialty
      - slot_was_set:
          - just_explained: true
      - action: action_explain_specialty_in_form
      - slot_was_set:
          - just_explained: false
      - action: search_prescription_form
      - active_loop: search_prescription_form
      - intent: provide_date
      - slot_was_set:
          - prescription_date: "15/10/2025"
      - active_loop: null
      - action: action_show_prescription_results

  # ← THÊM: Tìm toa thuốc với interruption - ask doctor info
  - story: search prescription with ask doctor info interruption
    steps:
      - intent: greet
      - action: utter_greet
      - intent: search_prescription
      - action: action_search_prescription
      - action: search_prescription_form
      - active_loop: search_prescription_form
      - intent: ask_doctor_info
      - slot_was_set:
          - just_asked_doctor_info: true
      - action: action_show_doctor_info_in_form
      - slot_was_set:
          - just_asked_doctor_info: false
      - action: search_prescription_form
      - active_loop: search_prescription_form
      - intent: provide_date
      - slot_was_set:
          - prescription_date: "15/10/2025"
      - active_loop: null
      - action: action_show_prescription_results

  # ← THÊM: Tìm toa thuốc với interruption - list doctors
  - story: search prescription with list doctors interruption
    steps:
      - intent: greet
      - action: utter_greet
      - intent: search_prescription
      - action: action_search_prescription
      - action: search_prescription_form
      - active_loop: search_prescription_form
      - intent: list_doctors_by_specialty
      - slot_was_set:
          - just_listed_doctors: true
      - action: action_list_doctors_in_form
      - slot_was_set:
          - just_listed_doctors: false
      - action: search_prescription_form
      - active_loop: search_prescription_form
      - intent: provide_date
      - slot_was_set:
          - prescription_date: "15/10/2025"
      - active_loop: null
      - action: action_show_prescription_results

  # ← THÊM: Không tìm thấy toa thuốc
  - story: search prescription not found
    steps:
      - intent: greet
      - action: utter_greet
      - intent: search_prescription
      - action: action_search_prescription
      - action: search_prescription_form
      - active_loop: search_prescription_form
      - intent: provide_date
      - slot_was_set:
          - prescription_date: "01/01/2020"
      - active_loop: null
      - action: action_show_prescription_results
      - intent: request_latest_prescription
      - action: action_get_latest_prescription
      - action: search_prescription_form
      - active_loop: search_prescription_form

  # ← THÊM: Deny trong prescription form
  - story: deny during prescription form
    steps:
      - intent: greet
      - action: utter_greet
      - intent: search_prescription
      - action: action_search_prescription
      - action: search_prescription_form
      - active_loop: search_prescription_form
      - intent: deny
      - action: action_handle_deny
      - active_loop: null
      - slot_was_set:
          - current_task: null
      - action: utter_ask_intent

  # ← THÊM: Out of scope trong prescription form
  - story: out of scope during prescription form
    steps:
      - intent: search_prescription
      - action: action_search_prescription
      - action: search_prescription_form
      - active_loop: search_prescription_form
      - intent: out_of_scope
      - action: action_handle_out_of_scope
      - intent: provide_date
      - slot_was_set:
          - prescription_date: "15/10/2025"
      - active_loop: null
      - action: action_show_prescription_results

  # ← THÊM: NLU fallback trong prescription form
  - story: nlu fallback in prescription form
    steps:
      - intent: search_prescription
      - action: action_search_prescription
      - action: search_prescription_form
      - active_loop: search_prescription_form
      - intent: nlu_fallback
      - action: action_default_fallback
      - intent: provide_date
      - slot_was_set:
          - prescription_date: "15/10/2025"
      - active_loop: null
      - action: action_show_prescription_results

  # ← THÊM: Multiple fallbacks trong prescription form
  - story: multiple nlu fallbacks in prescription form
    steps:
      - intent: search_prescription
      - action: action_search_prescription
      - action: search_prescription_form
      - active_loop: search_prescription_form
      - intent: nlu_fallback
      - action: action_default_fallback
      - intent: nlu_fallback
      - action: action_default_fallback
      - intent: provide_date
      - slot_was_set:
          - prescription_date: "15/10/2025"
      - active_loop: null
      - action: action_show_prescription_results

  # ← THÊM: Tìm toa thuốc sau khi đặt lịch
  - story: search prescription after booking
    steps:
      - intent: book_appointment
      - action: action_set_current_task
      - action: book_appointment_form
      - active_loop: book_appointment_form
      - intent: provide_specialty
      - slot_was_set:
          - specialty: nhi khoa
      - intent: choose_doctor_name
      - slot_was_set:
          - doctor_name: bác sĩ Anh
      - intent: provide_date
      - slot_was_set:
          - date: "20/10/2025"
      - intent: provide_time
      - slot_was_set:
          - appointment_time: "15:00"
      - intent: provide_decription
      - slot_was_set:
          - decription: khám bệnh
      - active_loop: null
      - action: action_book_appointment
      - intent: affirm
      - action: action_submit_booking
      - intent: search_prescription
      - action: action_search_prescription
      - action: search_prescription_form
      - active_loop: search_prescription_form

  # ← THÊM: Interruption hỏi bác sĩ đã khám trong book_appointment_form
  - story: book appointment with ask examining doctor interruption
    steps:
      - intent: book_appointment
      - action: action_set_current_task
      - action: book_appointment_form
      - active_loop: book_appointment_form
      - intent: provide_specialty
      - slot_was_set:
          - specialty: nhi khoa
      - intent: ask_who_examined_me # <-- User ngắt quãng
      - action: action_show_examining_doctor_in_form # <-- Action xử lý ngắt quãng
      - action: book_appointment_form # <-- Form tự động hỏi lại slot
      - active_loop: book_appointment_form
      - intent: choose_doctor_name # <-- User tiếp tục
      - slot_was_set:
          - doctor_name: bác sĩ Anh
      - intent: provide_date
      - slot_was_set:
          - date: "20/10/2025"
      - intent: provide_time
      - slot_was_set:
          - appointment_time: "15:00"
      - intent: provide_decription
      - slot_was_set:
          - decription: khám bệnh
      - active_loop: null
      - action: action_book_appointment
