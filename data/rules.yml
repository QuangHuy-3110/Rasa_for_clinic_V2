version: "3.1"

rules:
  # ===================== Đề xuất bác sĩ ============================
  - rule: Activate recommend doctor form
    steps:
      - intent: request_doctor
      - action: action_set_current_task
      - action: recommend_doctor_form
      - active_loop: recommend_doctor_form

  - rule: Submit recommend doctor form
    condition:
      - active_loop: recommend_doctor_form
    steps:
      - action: recommend_doctor_form
      - active_loop: null
      - action: action_recommend_doctor

  - rule: Handle new symptoms
    steps:
      - intent: provide_medical_info
      - action: action_recommend_doctor

  # ===================== Đề xuất bác sĩ + đặt lịch khám ============================
  - rule: Activate booking form after select doctor
    steps:
      - intent: book_with_doctor
      - action: action_book_with_doctor
      - action: action_set_current_task
      - action: book_appointment_form
      - active_loop: book_appointment_form

  # ===================== Đặt lịch khám ============================
  - rule: Activate book appointment form
    steps:
      - intent: book_appointment
      - action: action_set_current_task
      - action: book_appointment_form
      - active_loop: book_appointment_form

  # - rule: Submit book appointment form
  #   condition:
  #     - active_loop: book_appointment_form
  #   steps:
  #     - action: book_appointment_form
  #     - active_loop: null
  #     - action: action_book_appointment

  # ===================== Giải thích chuyên khoa (interruption) ============================
  - rule: Handle explain interruption in book_appointment
    condition:
      - slot_was_set:
          - just_explained: true
      - slot_was_set:
          - current_task: book_appointment
    steps:
      - action: action_explain_specialty_in_form
      - slot_was_set:
          - just_explained: false
      - action: book_appointment_form
      - active_loop: book_appointment_form
    wait_for_user_input: false # ← Thêm để rule chạy ngay

  # ===================== Misc ============================
  - rule: greet
    steps:
      - intent: greet
      - action: utter_greet

  - rule: Say goodbye anytime the user says goodbye
    steps:
      - intent: goodbye
      - action: utter_goodbye
