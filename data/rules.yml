version: "3.1"

rules:
  # ===================== XỬ LÝ OUT-OF-SCOPE (Ưu tiên cao) ============================
  - rule: Handle out of scope questions
    steps:
      - intent: out_of_scope
      - action: action_handle_out_of_scope

  - rule: Handle out of scope in any form
    condition:
      - active_loop: book_appointment_form
    steps:
      - intent: out_of_scope
      - action: action_handle_out_of_scope

  - rule: Handle out of scope in cancel form
    condition:
      - active_loop: cancel_appointment_form
    steps:
      - intent: out_of_scope
      - action: action_handle_out_of_scope

  - rule: Handle out of scope in recommend form
    condition:
      - active_loop: recommend_doctor_form
    steps:
      - intent: out_of_scope
      - action: action_handle_out_of_scope

  # ← THÊM: Handle out of scope trong prescription form
  - rule: Handle out of scope in prescription form
    condition:
      - active_loop: search_prescription_form
    steps:
      - intent: out_of_scope
      - action: action_handle_out_of_scope

  # ===================== XỬ LÝ NLU FALLBACK ============================
  - rule: Handle NLU fallback outside form
    steps:
      - intent: nlu_fallback
      - action: action_default_fallback

  - rule: Handle NLU fallback in book appointment form
    condition:
      - active_loop: book_appointment_form
    steps:
      - intent: nlu_fallback
      - action: action_default_fallback

  - rule: Handle NLU fallback in cancel appointment form
    condition:
      - active_loop: cancel_appointment_form
    steps:
      - intent: nlu_fallback
      - action: action_default_fallback

  - rule: Handle NLU fallback in recommend doctor form
    condition:
      - active_loop: recommend_doctor_form
    steps:
      - intent: nlu_fallback
      - action: action_default_fallback

  # ← THÊM: Handle fallback trong prescription form
  - rule: Handle NLU fallback in prescription form
    condition:
      - active_loop: search_prescription_form
    steps:
      - intent: nlu_fallback
      - action: action_default_fallback

  # ===================== TÌM TOA THUỐC ============================

  # ← THÊM: Kích hoạt form tìm toa thuốc
  - rule: Activate search prescription form
    steps:
      - intent: search_prescription
      - action: action_search_prescription
      - action: search_prescription_form
      - active_loop: search_prescription_form

  # ← THÊM: Submit form và hiển thị kết quả
  - rule: Submit search prescription form
    condition:
      - active_loop: search_prescription_form
    steps:
      - action: search_prescription_form
      - active_loop: null
      - action: action_show_prescription_results

  # ← THÊM: Xử lý tìm toa thuốc mới nhất
  - rule: Request latest prescription
    steps:
      - intent: request_latest_prescription
      - action: action_get_latest_prescription
      - action: search_prescription_form
      - active_loop: search_prescription_form

  # ← THÊM: Giải thích chuyên khoa trong prescription form
  - rule: Handle explain interruption in search_prescription
    condition:
      - slot_was_set:
          - just_explained: true
      - slot_was_set:
          - current_task: search_prescription
    steps:
      - action: action_explain_specialty_in_form
      - slot_was_set:
          - just_explained: false
      - action: search_prescription_form
      - active_loop: search_prescription_form
    wait_for_user_input: false

  # ← THÊM: Tra cứu thông tin bác sĩ trong prescription form
  - rule: Handle doctor info interruption in search_prescription
    condition:
      - slot_was_set:
          - just_asked_doctor_info: true
      - slot_was_set:
          - current_task: search_prescription
    steps:
      - action: action_show_doctor_info_in_form
      - slot_was_set:
          - just_asked_doctor_info: false
      - action: search_prescription_form
      - active_loop: search_prescription_form
    wait_for_user_input: false

  # ← THÊM: Liệt kê bác sĩ trong prescription form
  - rule: Handle list doctors interruption in search_prescription
    condition:
      - slot_was_set:
          - just_listed_doctors: true
      - slot_was_set:
          - current_task: search_prescription
    steps:
      - action: action_list_doctors_in_form
      - slot_was_set:
          - just_listed_doctors: false
      - action: search_prescription_form
      - active_loop: search_prescription_form
    wait_for_user_input: false

  # ← THÊM: Xử lý deny trong prescription form
  - rule: Handle deny in prescription form
    condition:
      - active_loop: search_prescription_form
    steps:
      - intent: deny
      - action: action_handle_deny
      - active_loop: null
      - action: utter_ask_intent
      - action: action_listen

  # ===================== Đề xuất bác sĩ ============================
  - rule: Activate recommend doctor form
    steps:
      - intent: request_doctor
      - action: action_set_current_task
      - action: recommend_doctor_form
      - active_loop: recommend_doctor_form

  - rule: Submit recommend doctor form
    condition:
      - active_loop: recommend_doctor_form
    steps:
      - action: recommend_doctor_form
      - active_loop: null
      - action: action_recommend_doctor

  - rule: Handle new symptoms
    steps:
      - intent: provide_medical_info
      - action: action_recommend_doctor

  # ===================== Đề xuất bác sĩ + đặt lịch khám ============================
  - rule: Activate booking form after select doctor
    steps:
      - intent: book_with_doctor
      - action: action_book_with_doctor
      - action: action_set_current_task
      - action: book_appointment_form
      - active_loop: book_appointment_form

  # ===================== Đặt lịch khám ============================
  - rule: Activate book appointment form
    steps:
      - intent: book_appointment
      - action: action_set_current_task
      - action: book_appointment_form
      - active_loop: book_appointment_form

  - rule: submit after book appointment form
    condition:
      - active_loop: book_appointment_form
    steps:
      - action: book_appointment_form
      - active_loop: null
      - action: action_book_appointment

  # ===================== Giải thích chuyên khoa (interruption) ============================
  - rule: Handle explain interruption in book_appointment
    condition:
      - slot_was_set:
          - just_explained: true
      - slot_was_set:
          - current_task: book_appointment
    steps:
      - action: action_explain_specialty_in_form
      - slot_was_set:
          - just_explained: false
      - action: book_appointment_form
      - active_loop: book_appointment_form
    wait_for_user_input: false

  - rule: Handle explain interruption in cancel_appointment
    condition:
      - slot_was_set:
          - just_explained: true
      - slot_was_set:
          - current_task: cancel_appointment
    steps:
      - action: action_explain_specialty_in_form
      - slot_was_set:
          - just_explained: false
      - action: cancel_appointment_form
      - active_loop: cancel_appointment_form
    wait_for_user_input: false

  - rule: Explain specialty
    steps:
      - intent: explain_specialty
      - action: action_explain_specialty_in_form

  # ===================== Tra cứu thông tin bác sĩ (interruption) ============================
  - rule: Handle doctor info interruption in book_appointment
    condition:
      - slot_was_set:
          - just_asked_doctor_info: true
      - slot_was_set:
          - current_task: book_appointment
    steps:
      - action: action_show_doctor_info_in_form
      - slot_was_set:
          - just_asked_doctor_info: false
      - action: book_appointment_form
      - active_loop: book_appointment_form
    wait_for_user_input: false

  - rule: Handle doctor info interruption in cancel_appointment
    condition:
      - slot_was_set:
          - just_asked_doctor_info: true
      - slot_was_set:
          - current_task: cancel_appointment
    steps:
      - action: action_show_doctor_info_in_form
      - slot_was_set:
          - just_asked_doctor_info: false
      - action: cancel_appointment_form
      - active_loop: cancel_appointment_form
    wait_for_user_input: false

  - rule: Show doctor info
    steps:
      - intent: ask_doctor_info
      - action: action_show_doctor_info_in_form

  # ===================== Liệt kê bác sĩ theo chuyên khoa (interruption) ============================
  - rule: Handle list doctors interruption in book_appointment
    condition:
      - slot_was_set:
          - just_listed_doctors: true
      - slot_was_set:
          - current_task: book_appointment
    steps:
      - action: action_list_doctors_in_form
      - slot_was_set:
          - just_listed_doctors: false
      - action: book_appointment_form
      - active_loop: book_appointment_form
    wait_for_user_input: false

  - rule: Handle list doctors interruption in cancel_appointment
    condition:
      - slot_was_set:
          - just_listed_doctors: true
      - slot_was_set:
          - current_task: cancel_appointment
    steps:
      - action: action_list_doctors_in_form
      - slot_was_set:
          - just_listed_doctors: false
      - action: cancel_appointment_form
      - active_loop: cancel_appointment_form
    wait_for_user_input: false

  - rule: List doctors by specialty
    steps:
      - intent: list_doctors_by_specialty
      - action: action_list_doctors_in_form

  # ===================== Hủy lịch khám ============================
  - rule: Activate cancel appointment form
    steps:
      - intent: cancel_appointment
      - action: action_cancel_appointment
      - action: cancel_appointment_form
      - active_loop: cancel_appointment_form

  - rule: Submit cancel appointment form and confirm
    condition:
      - active_loop: cancel_appointment_form
    steps:
      - action: cancel_appointment_form
      - active_loop: null
      - action: action_confirm_cancel

  - rule: Perform cancel after affirm
    condition:
      - slot_was_set:
          - selected_appointment_id:
      - slot_was_set:
          - current_task: cancel_appointment
    steps:
      - intent: affirm
      - action: action_perform_cancel

  # ===================== Xác nhận đặt lịch ============================
  - rule: Submit booking after affirm
    condition:
      - slot_was_set:
          - current_task: book_appointment
    steps:
      - intent: affirm
      - action: action_submit_booking

  - rule: Reset booking on deny
    condition:
      - slot_was_set:
          - current_task: book_appointment
    steps:
      - intent: deny
      - action: action_handle_deny
      - active_loop: null
      - action: utter_ask_intent
      - action: action_listen

  # ===================== Bác sĩ nào đã khám tôi (interruption) ============================
  - rule: Show examining doctor outside form # ← THÊM MỚI
    steps:
      - intent: ask_who_examined_me
      - action: action_show_examining_doctor_in_form

  - rule: List all doctors (outside form)
    steps:
      - intent: list_all_doctors
      - action: action_list_all_doctors

  - rule: Show doctor schedule (outside form)
    steps:
      - intent: ask_doctor_schedule
      - action: action_show_doctor_schedule

  - rule: Ask ask price
    steps:
      - intent: ask_price
      - action: utter_ask_price
  # ===================== Misc ============================
  - rule: greet
    steps:
      - intent: greet
      - action: utter_greet

  - rule: Say goodbye anytime the user says goodbye
    steps:
      - intent: goodbye
      - action: utter_goodbye

  - rule: Kích hoạt kiểm tra lịch hẹn khi người dùng đăng nhập
    steps:
      - intent: trigger_reminder_check_on_login
      - action: action_check_upcoming_appointments
      - action: action_listen
