version: "3.1"

intents:
  - greet
  - goodbye
  - request_doctor
  - affirm
  - deny
  - provide_medical_info
  - book_with_doctor
  - book_appointment
  - provide_decription
  - provide_specialty
  - choose_doctor_name
  - provide_time
  - provide_date
  # - search_doctor_info
  - explain_specialty
  - ask_doctor_info # ← THÊM intent mới
  - cancel_appointment
  - select_appointment
  - nlu_fallback

entities:
  - symptom
  - specialty
  - doctor_name
  - appointment_time
  - decription
  - date
  - time
  - appointment_id
  - doctor_id

slots:
  just_listed_doctors:
    type: bool
    initial_value: false
    influence_conversation: true
    mappings:
      - type: custom

  just_explained:
    type: bool
    initial_value: false
    influence_conversation: true
    mappings:
      - type: custom

  just_asked_doctor_info: # ← THÊM slot mới
    type: bool
    initial_value: false
    influence_conversation: true
    mappings:
      - type: custom

  symptoms:
    type: list
    influence_conversation: false
    mappings:
      - type: from_entity
        entity: symptom

  doctor_id:
    type: text
    influence_conversation: false
    mappings:
      - type: custom

  current_task:
    type: categorical
    influence_conversation: true
    values:
      - request_doctor
      - book_appointment
      - cancel_appointment
    mappings:
      - type: custom

  specialty_suggested:
    type: text
    influence_conversation: true
    mappings:
      - type: custom

  appointment_date:
    type: text
    influence_conversation: false
    mappings:
      - type: from_entity
        entity: date
      - type: custom

  prescription_date:
    type: text
    influence_conversation: false
    mappings:
      - type: from_text
      - type: custom

  doctor_name:
    type: text
    influence_conversation: true
    mappings:
      - type: from_entity
        entity: doctor_name
      - type: from_entity
        entity: doctor_name
        intent: choose_doctor_name
      - type: custom
      - type: from_text
        not_intent:
          - greet
          - goodbye
          - affirm
          - deny
          - book_appointment
          - request_doctor
          - provide_specialty
          - provide_date
          - provide_time
          - provide_decription
          - provide_medical_info
          - choose_doctor_name
          - book_with_doctor
          - explain_specialty
          - ask_doctor_info # ← THÊM để block extract khi interruption
          - list_doctors_by_specialty

  appointment_time:
    type: text
    influence_conversation: false
    mappings:
      - type: from_entity
        entity: appointment_time
      - type: from_entity
        entity: time
      - type: from_text
        not_intent:
          - greet
          - goodbye
          - affirm
          - deny
          - book_appointment
          - request_doctor
          - provide_specialty
          - provide_date
          - choose_doctor_name
          - provide_decription
          - provide_medical_info
          - provide_time
          - book_with_doctor
          - explain_specialty
          - ask_doctor_info # ← THÊM
          - list_doctors_by_specialty
      - type: custom

  decription:
    type: text
    influence_conversation: false
    mappings:
      - type: from_entity
        entity: decription
      - type: from_text
        intent:
          - provide_decription
          - provide_medical_info
      - type: custom

  specialty:
    type: text
    influence_conversation: true
    mappings:
      - type: from_entity
        entity: specialty
      - type: from_entity
        entity: specialty
        intent: provide_specialty
      - type: custom
      - type: from_text
        not_intent:
          - greet
          - goodbye
          - affirm
          - deny
          - book_appointment
          - request_doctor
          - provide_date
          - choose_doctor_name
          - provide_time
          - provide_decription
          - provide_medical_info
          - provide_specialty
          - book_with_doctor
          - ask_doctor_info # ← THÊM
          - list_doctors_by_specialty

  date:
    type: text
    influence_conversation: false
    mappings:
      - type: from_entity
        entity: date
      - type: from_text
        not_intent:
          - greet
          - goodbye
          - affirm
          - deny
          - book_appointment
          - request_doctor
          - provide_specialty
          - choose_doctor_name
          - provide_time
          - provide_decription
          - provide_medical_info
          - provide_date
          - book_with_doctor
          - explain_specialty
          - ask_doctor_info # ← THÊM
          - list_doctors_by_specialty
      - type: custom

  selected_appointment_id:
    type: text
    influence_conversation: false
    mappings:
      - type: from_entity
        entity: appointment_id
      - type: custom

responses:
  utter_greet:
    - text: "Xin chào! Tôi là chatbot hỗ trợ phòng khám. Bạn cần gì hôm nay?"
      buttons:
        - title: "Đề xuất bác sĩ"
          payload: "/request_doctor"
        - title: "Đặt lịch hẹn"
          payload: "/book_appointment"
        - title: "Hủy lịch hẹn"
          payload: "/cancel_appointment"

  utter_goodbye:
    - text: "Tạm biệt! Chúc bạn sức khỏe."

  utter_ask_symptoms:
    - text: "Bạn đang gặp triệu chứng gì? Hãy mô tả chi tiết (có thể liệt kê nhiều, ví dụ: 'đau đầu, sốt')."

  utter_ask_specialty:
    - text: "Bạn muốn khám chuyên khoa nào? \nCác chuyên khoa mà chúng tôi hỗ trợ bao gồm: nội khoa, ngoại khoa, nha khoa, phụ sản, nhi khoa, thần kinh. \nVui lòng nhập tên chuyên khoa."

  utter_explain_specialty:
    - text: "Bạn muốn tìm hiểu về chuyên khoa nào? Vui lòng nhập tên chuyên khoa."

  utter_ask_doctor_info: # ← THÊM response mới
    - text: "Bạn muốn xem thông tin của bác sĩ nào? Vui lòng nhập tên bác sĩ."

  utter_specialty_not_found:
    - text: "Chuyên khoa '{specialty}' không hợp lệ hoặc không có sẵn. Vui lòng chọn từ danh sách sau hoặc nhập lại:"

  utter_ask_doctor_name:
    - text: "Bạn muốn khám với bác sĩ nào? Vui lòng chọn hoặc nhập tên bác sĩ."

  utter_doctor_info:
    - text: "Bạn muốn tra cứu thông tin bác sĩ nào? Vui lòng nhập tên bác sĩ."

  utter_ask_appointment_time:
    - text: "Bạn muốn đặt lịch vào thời gian nào? Vui lòng cho biết thời gian cụ thể."

  utter_ask_decription:
    - text: "Hãy cho tôi biết thêm chi tiết về tình trạng của bạn."

  utter_ask_date:
    - text: "Bạn muốn đặt lịch vào ngày nào? Vui lòng cho biết ngày cụ thể."

  utter_confirm:
    - text: "Bạn có muốn đặt lịch với bác sĩ này không?"
      buttons:
        - title: "Có"
          payload: "affirm"
        - title: "Không"
          payload: "deny"

  utter_confirm_booking:
    - text: "Bạn có muốn xác nhận đặt lịch với bác sĩ {doctor_name} vào {appointment_time} ngày {date} cho chuyên khoa {specialty} với mô tả bệnh trạng: '{decription}' không?"
      buttons:
        - title: "Có"
          payload: "/affirm"
        - title: "Không"
          payload: "/deny"

  utter_appointment_cancelled:
    - text: "Bạn đã hủy đặt lịch hẹn."

  utter_default_error:
    - text: "Có lỗi xảy ra. Vui lòng thử lại sau."

  utter_recommend_doctor_no_doctors:
    - text: "Không tìm thấy bác sĩ phù hợp với triệu chứng của bạn. Vui lòng thử mô tả khác."

  utter_recommend_doctor_success:
    - text: "Dựa trên triệu chứng, tôi gợi ý chuyên khoa: {specialty_suggested}."

  utter_validate_date_wrong_input:
    - text: "Thông tin bạn nhập không phải ngày tháng. Vui lòng nhập đúng định dạng DD/MM/YYYY."

  utter_validate_date_invalid:
    - text: "Định dạng ngày không hợp lệ. Vui lòng nhập DD/MM/YYYY."

  utter_validate_date_past:
    - text: "Không thể đặt lịch trong quá khứ. Vui lòng chọn ngày trong tương lai."

  utter_validate_time_wrong_input:
    - text: "Thông tin bạn nhập không phải thời gian. Vui lòng nhập HH:MM."

  utter_validate_time_invalid:
    - text: "Định dạng thời gian không hợp lệ. Vui lòng nhập HH:MM."

  utter_validate_time_outside_hours:
    - text: "Thời gian phải từ 8:00 đến 17:00. Vui lòng chọn giờ hợp lệ."

  utter_validate_decription_wrong_input:
    - text: "Thông tin bạn nhập không phải mô tả bệnh. Vui lòng mô tả chi tiết tình trạng."

  utter_doctor_not_found:
    - text: "Không tìm thấy bác sĩ '{doctor_name}' trong chuyên khoa {specialty}. Vui lòng chọn từ danh sách:"

  utter_search_doctor:
    - text: "Vui lòng nhập tên bác sĩ bạn muốn tra cứu."

  utter_search_doctor_no_results:
    - text: "Không tìm thấy bác sĩ '{doctor_name}'."

  utter_search_doctor_results:
    - text: "Kết quả tra cứu cho '{doctor_name}':"

  utter_specialty_info:
    - text: "Chuyên khoa {specialty}: {explanation}"

  utter_ask_cancel_date:
    - text: "Vui lòng nhập ngày bạn muốn hủy lịch hẹn (DD/MM/YYYY)."

  utter_cancel_no_appointments:
    - text: "Không có lịch hẹn nào trong ngày {appointment_date}."

  utter_cancel_list:
    - text: "Danh sách lịch hẹn ngày {appointment_date}:"

  utter_confirm_cancel:
    - text: "Bạn có chắc muốn hủy lịch hẹn {selected_appointment_id} không?"
      buttons:
        - title: "Có"
          payload: "/affirm"
        - title: "Không"
          payload: "/deny"

  utter_cancel_success:
    - text: "Đã hủy lịch hẹn thành công."

  utter_cancel_error:
    - text: "Có lỗi khi hủy lịch hẹn. Vui lòng thử lại."

  utter_reset_booking:
    - text: "Đã hủy yêu cầu đặt lịch. Bạn có thể bắt đầu lại."

  utter_reset_cancel:
    - text: "Đã hủy hành động hủy lịch. Lịch hẹn vẫn giữ nguyên."

  utter_booking_success:
    - text: "Đặt lịch thành công! Cảm ơn bạn."

  utter_booking_error:
    - text: "Có lỗi xảy ra khi đặt lịch. Vui lòng thử lại."

  utter_booking_incomplete:
    - text: "Thông tin đặt lịch chưa đầy đủ. Vui lòng kiểm tra lại."

  utter_ask_again:
    - text: "Xin lỗi, tôi không hiểu rõ câu hỏi của bạn. Bạn có thể nói lại hoặc chọn một trong các tùy chọn không?"

  utter_ask_intent:
    - text: "Bạn muốn làm gì tiếp theo? Vui lòng chọn một trong các tùy chọn sau:"
      buttons:
        - title: "Đề xuất bác sĩ"
          payload: "/request_doctor"
        - title: "Đặt lịch hẹn"
          payload: "/book_appointment"
        - title: "Hủy lịch hẹn"
          payload: "/cancel_appointment"

forms:
  recommend_doctor_form:
    required_slots:
      - symptoms

  book_appointment_form:
    required_slots:
      - specialty
      - doctor_name
      - date
      - appointment_time
      - decription

actions:
  - action_recommend_doctor
  - validate_recommend_doctor_form
  - action_book_with_doctor
  - action_set_current_task
  - validate_book_appointment_form
  - action_book_appointment
  - action_reactivate_book_form
  - action_search_doctor
  - action_view_doctor_detail
  - action_search_specialty
  - action_cancel_appointment
  - action_confirm_cancel
  - action_perform_cancel
  - action_search_prescription
  - action_submit_booking
  - action_reset_booking
  - action_reset_cancel
  - validate_my_form
  - action_deactivate_my_form
  - action_stop_form
  - action_explain_specialty_in_form
  - action_show_doctor_info_in_form # ← THÊM action mới
  - action_list_doctors_in_form
  - action_handle_deny

session_config:
  session_expiration_time: 60
  carry_over_slots_to_new_session: true
